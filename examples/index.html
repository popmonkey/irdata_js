<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iRacing Data API Example</title>
  </head>
  <body>
    <h1>iRacing Data API Example</h1>

    <div id="config-error" style="display: none; color: red">
      Error loading auth_config.json. Please ensure it exists in examples/ directory.
    </div>

    <div id="login-section" style="display: none">
      <h2>1. Login</h2>
      <p>Click below to start OAuth flow.</p>
      <button id="login-btn">Login to iRacing</button>
    </div>

    <div id="callback-section" style="display: none">
      <h2>2. Callback Handling</h2>
      <p>Processing authentication code...</p>
      <div
        id="status"
        style="white-space: pre-wrap; background: #fff0f0; padding: 10px; display: none"
      ></div>
    </div>

    <div id="data-section" style="display: none">
      <h2>3. Test Endpoints</h2>

      <table border="1" cellpadding="10" style="border-collapse: collapse; width: 100%">
        <thead>
          <tr>
            <th style="text-align: left">Endpoint</th>
            <th style="text-align: left">Parameters</th>
            <th style="text-align: left">Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Member Info -->
          <tr>
            <td>
              <strong>Member Info</strong><br />
              <small>/data/member/info</small>
            </td>
            <td><em>None</em></td>
            <td><button id="btn-member-info">Fetch Member Info</button></td>
          </tr>

          <!-- Categories -->
          <tr>
            <td>
              <strong>Categories</strong><br />
              <small>/data/constants/categories</small>
            </td>
            <td><em>None</em></td>
            <td><button id="btn-categories">Fetch Categories</button></td>
          </tr>

          <!-- Season Driver Standings -->
          <tr>
            <td>
              <strong>Season Driver Standings</strong><br />
              <small>/data/stats/season_driver_standings</small>
            </td>
            <td>
              <div style="margin-bottom: 5px">
                <label for="inp-season-id">Season ID:</label>
                <input type="number" id="inp-season-id" value="5935" style="width: 80px" />
              </div>
              <div style="margin-bottom: 5px">
                <label for="inp-car-class-id">Car Class ID:</label>
                <input type="number" id="inp-car-class-id" value="4011" style="width: 80px" />
              </div>
              <div>
                <label for="inp-race-week-num">Race Week Num:</label>
                <input
                  type="number"
                  id="inp-race-week-num"
                  value=""
                  style="width: 80px"
                  placeholder="Optional"
                />
              </div>
            </td>
            <td><button id="btn-standings">Fetch Standings</button></td>
          </tr>
        </tbody>
      </table>

      <h3>Output</h3>
      <!-- Chunk Walker UI -->
      <div
        id="chunk-section"
        style="
          display: none;
          margin-bottom: 10px;
          padding: 10px;
          border: 1px solid #aaa;
          background: #eef;
        "
      >
        <h4 style="margin-top: 0">Chunk Walker</h4>
        <p style="margin: 5px 0">
          <strong>Total Chunks:</strong> <span id="chunk-total">0</span> |
          <strong>Total Rows:</strong> <span id="chunk-rows">0</span>
        </p>
        <div>
          <button id="btn-start-walker">Start / Reset Walker</button>
          <button id="btn-prev-chunk" disabled>&laquo; Prev Chunk</button>
          <span id="chunk-current-display" style="margin: 0 10px">Chunk - / -</span>
          <button id="btn-next-chunk" disabled>Next Chunk &raquo;</button>
          <button id="btn-fetch-all-chunks" style="margin-left: 20px">Fetch All Chunks</button>
        </div>
        <pre
          id="chunk-output"
          style="
            background: #fff;
            padding: 10px;
            border: 1px solid #ccc;
            max-height: 300px;
            overflow: auto;
            white-space: pre-wrap;
            margin-top: 10px;
          "
        >
Select "Start / Reset Walker" to begin.</pre
        >
      </div>

      <pre
        id="output"
        style="
          background: #f4f4f4;
          padding: 10px;
          border: 1px solid #ccc;
          max-height: 500px;
          overflow: auto;
          white-space: pre-wrap;
        "
      ></pre>
    </div>

    <script type="module">
      import { IRacingClient } from '../dist/index.js';

      async function init() {
        let config;
        try {
          const response = await fetch('./auth_config.json');
          if (!response.ok) throw new Error('Config not found');
          const authConfig = await response.json();

          config = {
            auth: authConfig,
            apiUrl: 'http://127.0.0.1/data',
            fileProxyUrl: 'http://127.0.0.1/passthrough',
          };
        } catch (e) {
          console.error('Could not load auth_config.json', e);
          document.getElementById('config-error').style.display = 'block';
          return;
        }

        const client = new IRacingClient(config);

        // UI Elements
        const loginBtn = document.getElementById('login-btn');
        const loginSection = document.getElementById('login-section');
        const callbackSection = document.getElementById('callback-section');
        const dataSection = document.getElementById('data-section');

        const btnMemberInfo = document.getElementById('btn-member-info');
        const btnCategories = document.getElementById('btn-categories');
        const btnStandings = document.getElementById('btn-standings');

        const output = document.getElementById('output');
        const status = document.getElementById('status');

        // Chunk Walker Elements
        const chunkSection = document.getElementById('chunk-section');
        const chunkTotalEl = document.getElementById('chunk-total');
        const chunkRowsEl = document.getElementById('chunk-rows');
        const btnStartWalker = document.getElementById('btn-start-walker');
        const btnPrevChunk = document.getElementById('btn-prev-chunk');
        const btnNextChunk = document.getElementById('btn-next-chunk');
        const chunkCurrentDisplay = document.getElementById('chunk-current-display');
        const btnFetchAllChunks = document.getElementById('btn-fetch-all-chunks');
        const chunkOutput = document.getElementById('chunk-output');

        // State for Chunk Walker
        let currentChunkResponse = null;
        let currentChunkIndex = 0;

        // Show Login Section initially
        loginSection.style.display = 'block';

        // Check for Auth Code in URL
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');

        if (code) {
          handleCallback(code);
        } else {
          // Check if we are already logged in (have token)
          const token = client.auth.accessToken;
          if (token) {
            console.log('Found existing access token, restoring session...');
            status.style.display = 'block';
            status.innerText = 'Session restored from local storage.';
            showDataSection();
          }
        }

        loginBtn.addEventListener('click', async () => {
          try {
            const url = await client.auth.generateAuthUrl();
            console.log('Redirecting to:', url);
            window.location.href = url;
          } catch (err) {
            console.error(err);
            alert('Error generating auth URL: ' + err.message);
          }
        });

        async function handleCallback(code) {
          loginSection.style.display = 'none';
          callbackSection.style.display = 'block';
          status.style.display = 'block';
          status.innerText = 'Exchanging code for token...';

          try {
            await client.auth.handleCallback(code);
            status.innerText = 'Success! Token received.';

            // Clear query params to clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);

            showDataSection();
          } catch (err) {
            console.error(err);
            let errorMessage = 'Error: ' + err.message;
            if (err.body) {
              const bodyStr =
                typeof err.body === 'object' ? JSON.stringify(err.body, null, 2) : err.body;
              errorMessage += '\n\nResponse Body:\n' + bodyStr;
            }
            status.innerText = errorMessage;
          }
        }

        function showDataSection() {
          loginSection.style.display = 'none';
          callbackSection.style.display = 'none';
          dataSection.style.display = 'block';
        }

        function resetChunkWalker() {
          chunkSection.style.display = 'none';
          currentChunkResponse = null;
          currentChunkIndex = 0;
          btnPrevChunk.disabled = true;
          btnNextChunk.disabled = true;
          chunkOutput.innerText = 'Select "Start / Reset Walker" to begin.';
        }

        function updateChunkButtons() {
          if (!currentChunkResponse || !currentChunkResponse.chunk_info) return;
          const numChunks = currentChunkResponse.chunk_info.num_chunks;

          chunkCurrentDisplay.innerText = `Chunk ${currentChunkIndex + 1} / ${numChunks}`;

          btnPrevChunk.disabled = currentChunkIndex <= 0;
          btnNextChunk.disabled = currentChunkIndex >= numChunks - 1;
        }

        async function fetchCurrentChunk() {
          if (!currentChunkResponse) return;
          chunkOutput.innerText = `Fetching Chunk ${currentChunkIndex + 1}...`;

          try {
            const chunkData = await client.getChunk(currentChunkResponse, currentChunkIndex);
            const summary = `// Chunk ${currentChunkIndex + 1} of ${currentChunkResponse.chunk_info.num_chunks} (${chunkData.length} items)\n\n`;
            chunkOutput.innerText = summary + JSON.stringify(chunkData, null, 2);
          } catch (err) {
            console.error(err);
            chunkOutput.innerText = `Error fetching chunk: ${err.message}`;
          }
        }

        btnStartWalker.addEventListener('click', () => {
          if (!currentChunkResponse) return;
          currentChunkIndex = 0;
          updateChunkButtons();
          fetchCurrentChunk();
        });

        btnPrevChunk.addEventListener('click', () => {
          if (currentChunkIndex > 0) {
            currentChunkIndex--;
            updateChunkButtons();
            fetchCurrentChunk();
          }
        });

        btnNextChunk.addEventListener('click', () => {
          if (
            currentChunkResponse &&
            currentChunkIndex < currentChunkResponse.chunk_info.num_chunks - 1
          ) {
            currentChunkIndex++;
            updateChunkButtons();
            fetchCurrentChunk();
          }
        });

        btnFetchAllChunks.addEventListener('click', async () => {
          if (!currentChunkResponse) return;
          chunkOutput.innerText = 'Fetching ALL chunks (this may take a moment)...';
          try {
            const allData = await client.getChunks(currentChunkResponse);
            const summary = `// ALL Chunks Merged (${allData.length} items)\n\n`;
            chunkOutput.innerText = summary + JSON.stringify(allData, null, 2);
          } catch (err) {
            console.error(err);
            chunkOutput.innerText = `Error fetching all chunks: ${err.message}`;
          }
        });

        async function fetchData(endpoint, description) {
          resetChunkWalker();
          output.innerText = `Loading ${description}...`;
          try {
            const data = await client.getData(endpoint);
            output.innerText = JSON.stringify(data, null, 2);
            console.log(`${description}:`, data);

            // Check for chunk_info
            if (data && data.chunk_info) {
              console.log('Chunk info detected:', data.chunk_info);
              currentChunkResponse = data;
              currentChunkIndex = 0;

              chunkTotalEl.innerText = data.chunk_info.num_chunks;
              chunkRowsEl.innerText = data.chunk_info.rows;
              chunkSection.style.display = 'block';
              
              // Initialize buttons but don't fetch yet
              btnPrevChunk.disabled = true;
              btnNextChunk.disabled = true;
              chunkCurrentDisplay.innerText = `Chunk - / ${data.chunk_info.num_chunks}`;
            }
          } catch (err) {
            console.error(err);
            console.error(err);
            let errorMessage = `Error fetching ${description}: ${err.message}`;

            if (err.body) {
              const bodyStr =
                typeof err.body === 'object' ? JSON.stringify(err.body, null, 2) : err.body;
              errorMessage += `\n\nResponse Body:\n${bodyStr}`;
            }

            output.innerText = errorMessage;
          }
        }

        btnMemberInfo.addEventListener('click', () => {
          fetchData('/member/info', 'Member Info');
        });

        btnCategories.addEventListener('click', () => {
          fetchData('/constants/categories', 'Categories');
        });

        btnStandings.addEventListener('click', () => {
          const seasonId = document.getElementById('inp-season-id').value;
          const carClassId = document.getElementById('inp-car-class-id').value;
          const raceWeekNum = document.getElementById('inp-race-week-num').value;

          if (!seasonId || !carClassId) {
            alert('Please enter both Season ID and Car Class ID');
            return;
          }

          // Construct URL with query parameters
          const queryParams = {
            season_id: seasonId,
            car_class_id: carClassId,
          };

          if (raceWeekNum) {
            queryParams.race_week_num = raceWeekNum;
          }

          const params = new URLSearchParams(queryParams);

          fetchData(
            `/stats/season_driver_standings?${params.toString()}`,
            'Season Driver Standings',
          );
        });
      }

      init();
    </script>
  </body>
</html>
